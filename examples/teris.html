<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Teris</title>
    <style>
        body {
            overflow: hidden;
            margin: 0;
        }
        #area {
            width: 320px;
            height: 480px;
            margin: auto;
            border: 1px solid green;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div id="area">
        <canvas id="game-canvas"></canvas>
    </div>
    <script>
        function Animation(time, type) {
            this.time = time;
            this.animationType = type || Animation.smooth;
            this.requestId = null;
        };
        Animation.prototype = {
            constructor: Animation,
            start: function () {
                var that = this;
                var now = new Date().getTime();
                if (this.startFn) {
                    this.startFn();
                }
                (function step(time) {
                    time = new Date().getTime() - now;
                    if (time < that.time) {
                        var k = that.animationType(time, that.time);
                        if (that.updateFn) {
                            that.updateFn(k);
                        }
                        that.requestId = requestAnimationFrame(step);
                    }
                    else {
                        that.updateFn(1);
                        if (that.completeFn) {
                            that.completeFn();
                        }
                        that.stop();
                    }
                })();
            },
            onUpdate: function (fn) {
                this.updateFn = fn;
                return this;
            },  
            onComplete: function (fn) {
                this.completeFn = fn;
                return this;
            },
            onStart: function (fn) {
                this.startFn = fn;
                return this;
            },
            stop: function () {
                window.cancelAnimationFrame(this.requestId);
            }
        };
        Animation.smooth = function (elapsed, end) {
            var k = elapsed / end;
            return k * k * (2 - k);
        };
    </script>
    <script>
        function Tap() {};
        Tap.tapEvent = (function () {
            var tapEvent = document.createEvent("CustomEvent");
            tapEvent.initCustomEvent("tap", true, false, "");
            return tapEvent;
        })();
        (function () {
            var moving = false, touched = false;
            var obj = {};
            function touchstart(ev) {
                touched = true;
            }

            function touchmove(ev) {
                if (touched) {
                    moving = true;
                }
            }

            function touchend(ev) {
                ev.preventDefault();
                var rect = ev.target.getBoundingClientRect();
                var touch;
                if ("ontouchstart" in document.body) {
                    touch = ev.changedTouches[0];
                }
                else {
                    touch = ev;
                }
                obj.x = touch.clientX - rect.left;
                obj.y = touch.clientY - rect.top;
                if (!moving) {
                    ev.target.dispatchEvent(Tap.tapEvent);
                }
                touched = false;
                moving = false;
            }
            Tap.add = function (dom, fn, isProp) {
                if ("ontouchstart" in document.body) {
                    dom.addEventListener("touchstart", touchstart, isProp);
                    dom.addEventListener("touchmove", touchmove, isProp);
                    dom.addEventListener("touchend", touchend, isProp);
                    dom.addEventListener("tap", fn.bind(obj), isProp);
                }
                else {
                    dom.addEventListener("mousedown", touchstart, isProp);
                    dom.addEventListener("mousemove", touchmove, isProp);
                    dom.addEventListener("mouseup", touchend, isProp);
                    dom.addEventListener("click", fn.bind(obj), isProp);
                }
            }
        })();
    </script>
    <script>
        function Button(content, pos, tapFn) {
            this.content = content;
            this.pos = pos;
            this.tapFn = tapFn;
            this.width = 35;
            this.height = 35;
        }
        Button.prototype = {
            draw: function (ctx, pos) {
                var width = this.width, height = this.height;
                ctx.save();
                ctx.strokeStyle = "black";
                ctx.lineWidth = 1;
                ctx.translate(this.pos.x, this.pos.y);

                if (!(pos.x < this.pos.x - width / 2 || pos.x > this.pos.x + width / 2 || 
                        pos.y < this.pos.y - height / 2 || pos.y > this.pos.y + height / 2)) {
                    this.tapFn();
                    ctx.strokeStyle = "red";
                    pos.x = 0;
                    pos.y = 0;
                }
                ctx.beginPath();
                ctx.rect(-width / 2, -height / 2, width, height);
                ctx.stroke();
                ctx.font = "16px arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(this.content, 0, 0);
                ctx.restore();
            }
        }
    </script>
    <script>
        var squareBase = {
            down: function () { this.y++; },
            left: function () { this.x--; },
            right: function () { this.x++; },
            clone: function () {
                var tempSquare = new this.constructor(this.x, this.y, this.state);
                return tempSquare;
            },
            rotateLeft: function () { 
                if (this.state == 0) {
                    this.state = 3;
                }
                else {
                    this.state--;
                }
            },
            rotateRight: function () {
                if (this.state == 3) {
                    this.state = 0;
                }
                else {
                    this.state++;
                }
            }
        };
    </script>
    <script>
        function Line(x, y, state) {
            this.x = x; 
            this.y = y;
            this.color = "#00ff00";
            this.state = state > 1 ? 1 : 0; // 0为竖直， 1为横向
        }
        Line.prototype = Object.create(squareBase);
        Line.prototype.constructor = Line;
        Line.prototype.rotateLeft = function () {
            if (this.state == 0) this.state = 1;
            else this.state = 0;
        };
        Line.prototype.rotateRight = function () {
            this.rotateLeft();
        };
        Line.prototype.canRotateLeft = function (posList) {
            if (this.state == 0) {
                if (this.y > 0) {
                    return this.x < 8 && this.x > 0 && posList[this.x - 1][this.y -1] == 0 && 
                        posList[this.x][this.y - 1] == 0 && 
                        posList[this.x + 1][this.y - 1] == 0 && 
                        posList[this.x + 2][this.y - 1] == 0;
                }
                return this.x < 8 && this.x > 0;
                
            }
            else {
                if (this.y > 2) {
                    return posList[this.x][this.y - 3] == 0 && 
                        posList[this.x][this.y - 2] == 0 && 
                        posList[this.x][this.y - 1] == 0 &&
                        posList[this.x][this.y] == 0;
                }
                else if (this.y > 1) {
                    return posList[this.x][this.y - 2] == 0 && 
                        posList[this.x][this.y - 1] == 0 &&
                        posList[this.x][this.y] == 0;
                }
                else if (this.y > 0) {
                    return posList[this.x][this.y - 1] == 0 &&
                        posList[this.x][this.y] == 0;
                }
            }
        };
        Line.prototype.canRotateRight = function(posList) {
            return this.canRotateLeft(posList);
        };
        Line.prototype.draw = function (ctx) {
            ctx.save();
            ctx.fillStyle = this.color;
            if (this.state == 0) {
                ctx.fillRect(this.x * 16 + 1, (this.y - 3) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, (this.y - 2) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, (this.y - 1)* 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, this.y * 16 + 1, 14, 14);
            }
            else {
                ctx.fillRect((this.x - 1) * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect((this.x + 1) * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect((this.x + 2) * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
            }
            ctx.restore();
        };
        Line.prototype.canDown = function (posList) {
            if (this.state == 0) {
                return this.y < 19 && posList[this.x][this.y + 1] == 0;
            }
            else {
                return this.y < 20 && posList[this.x - 1][this.y] == 0 && posList[this.x][this.y] == 0 && 
                    posList[this.x + 1][this.y] == 0 && posList[this.x + 2][this.y] == 0;
            }
        };
        Line.prototype.canLeft = function(posList) {
            if (this.state == 0) {
                if (this.y > 2) {
                    return this.x > 0 && posList[this.x - 1][this.y - 3] == 0 && 
                        posList[this.x - 1][this.y - 2] == 0 &&
                        posList[this.x - 1][this.y - 1] == 0 && 
                        posList[this.x - 1][this.y] == 0;
                }
                else if (this.y > 1) {
                    return this.x > 0 && posList[this.x - 1][this.y - 2] == 0 &&
                        posList[this.x - 1][this.y - 1] == 0 && 
                        posList[this.x - 1][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x > 0 && posList[this.x - 1][this.y - 1] == 0 && 
                        posList[this.x - 1][this.y] == 0;
                } 
                else {
                    return this.x > 0 && posList[this.x - 1][this.y] == 0;
                }
            }
            else {
                if (this.y > 0) {
                    return this.x > 1 && posList[this.x - 2][this.y - 1] == 0;
                }
                return true;
            }
        };
        Line.prototype.canRight = function (posList) {
            if (this.state == 0) {
                if (this.y > 2) {
                    return this.x < 9 && posList[this.x + 1][this.y - 3] == 0 && 
                           posList[this.x + 1][this.y - 2] == 0 &&
                           posList[this.x + 1][this.y - 1] == 0 && 
                           posList[this.x + 1][this.y] == 0
                }
                else if (this.y > 1) {
                    return this.x < 9 && posList[this.x + 1][this.y - 2] == 0 &&
                           posList[this.x + 1][this.y - 1] == 0 && 
                           posList[this.x + 1][this.y] == 0
                }
                else if (this.y > 0) {
                    return this.x < 9 && posList[this.x + 1][this.y - 1] == 0 && 
                           posList[this.x + 1][this.y] == 0
                } 
                else {
                    return this.x < 9 && posList[this.x + 1][this.y] == 0;
                }
            }
            else {
                return this.x < 7 && posList[this.x + 3][this.y - 1] == 0;
            }
        };
        Line.prototype.canChangeToList = function (posList) {
            if (this.state == 0) {
                return this.y > 2;
            }
            else {
                return this.y > 0;
            }
        };
        Line.prototype.changeToList = function (posList) {
            if (this.state == 0) {
                posList[this.x][this.y - 3] = 1;
                posList[this.x][this.y - 2] = 1;
                posList[this.x][this.y - 1] = 1;
                posList[this.x][this.y] = 1;
            }
            else {
                posList[this.x - 1][this.y - 1] = 1;
                posList[this.x][this.y - 1] = 1;
                posList[this.x + 1][this.y - 1] = 1;
                posList[this.x + 2][this.y - 1] = 1;
            }
        };
    </script>
    <script>
        function Square(x, y, state) {
            this.x = x;
            this.y = y;
            this.color = "#ff0000";
            this.state = 0;
        }
        Square.prototype = Object.create(squareBase);
        Square.prototype.constructor = Square;
        Square.prototype.rotateLeft = function () {
            return false;
        };
        Square.prototype.rotateRight = function () {
            return false;
        };
        Square.prototype.canRotateLeft = function (posList) {
            return true;
        };
        Square.prototype.canRotateRight = function (posList) {
            return true;
        };
        Square.prototype.draw = function (ctx) {
            ctx.save();
            ctx.fillStyle = this.color;

            ctx.fillRect(this.x * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
            ctx.fillRect(this.x * 16 + 1, this.y * 16 + 1, 14, 14);
            ctx.fillRect((this.x + 1) * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
            ctx.fillRect((this.x + 1) * 16 + 1, this.y * 16 + 1, 14, 14);
                
            ctx.restore();
        };
        Square.prototype.canDown = function (posList) {
            return this.y < 19 && posList[this.x][this.y + 1] == 0 && posList[this.x + 1][this.y + 1] == 0;
        };
        Square.prototype.canLeft = function(posList) {
            if (this.y > 1) {
                return this.x > 0 && posList[this.x - 1][this.y - 1] == 0 && 
                        posList[this.x - 1][this.y] == 0;
            }
            else {
                return this.x > 0 && posList[this.x - 1][this.y] == 0;
            }
        };
        Square.prototype.canRight = function (posList) {
            if (this.y > 1) {
                return this.x < 8 && posList[this.x + 2][this.y - 1] == 0 && 
                        posList[this.x + 2][this.y] == 0;
            }
            else {
                return this.x < 8 && posList[this.x + 2][this.y] == 0;
            }
        };
        Square.prototype.canChangeToList = function (posList) {
            return this.y > 0;
        };
        Square.prototype.changeToList = function (posList) {
            posList[this.x][this.y - 1] = 2;
            posList[this.x][this.y] = 2;
            posList[this.x + 1][this.y - 1] = 2;
            posList[this.x + 1][this.y] = 2;
        };
    </script>
    <script>
        function SevenL(x, y, state) {
            this.x = x;
            this.y = y;
            this.color = "#f348e2";
            this.state = state || 0;
        }
        SevenL.prototype = Object.create(squareBase);
        SevenL.prototype.constructor = SevenL;
        SevenL.prototype.canRotateLeft = function (posList) {
            if (this.state == 0) {
                if (this.y > 0) {
                    return this.x > 0 && this.x < 9 && 
                           posList[this.x - 1][this.y] == 0 && 
                           posList[this.x][this.y] == 0 && 
                           posList[this.x + 1][this.y] == 0 &&
                           posList[this.x + 1][this.y - 1] == 0;
                }
                else {
                    return this.x > 0 && this.x < 9 && 
                           posList[this.x - 1][this.y] == 0 && 
                           posList[this.x][this.y] == 0 && 
                           posList[this.x + 1][this.y] == 0;
                }
            }
            else if (this.state == 1) {
                if (this.y > 1) {
                    return this.x < 9 && posList[this.x][this.y - 2] == 0 && 
                           posList[this.x][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0 &&
                           posList[this.x + 1][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x < 9 && posList[this.x][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0 &&
                           posList[this.x + 1][this.y] == 0;
                }
                else {
                    return this.x < 9 && posList[this.x][this.y] == 0 &&
                           posList[this.x + 1][this.y] == 0;
                }
            }
            else if (this.state == 2) {
                if (this.y > 0) {
                    return this.x > 0 && this.x < 9 && posList[this.x - 1][this.y - 1] == 0 && 
                           posList[this.x][this.y - 1] == 0 && 
                           posList[this.x + 1][this.y - 1] == 0 &&
                           posList[this.x - 1][this.y] == 0;
                }
                else {
                    return this.x > 0 && this.x < 9 && posList[this.x - 1][this.y] == 0;
                }
            }
            else {
                if (this.y > 1) {
                    return this.x > 0 &&  posList[this.x][this.y - 2] == 0 && 
                           posList[this.x][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0 &&
                           posList[this.x - 1][this.y - 2] == 0;
                }
                else if (this.y > 0) {
                    return this.x > 0 && posList[this.x][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0;
                }
                else {
                    return this.x > 0 && posList[this.x][this.y] == 0;
                }
            }
        };
        SevenL.prototype.canRotateRight = function (posList) {
            if (this.state == 0) {
                if (this.y > 0) {
                    return this.x > 0 && this.x < 9 && posList[this.x - 1][this.y - 1] == 0 && 
                           posList[this.x][this.y - 1] == 0 && 
                           posList[this.x + 1][this.y - 1] == 0 &&
                           posList[this.x - 1][this.y] == 0;
                }
                else {
                    return this.x > 0 && this.x < 9 && posList[this.x - 1][this.y] == 0;
                }
            }
            else if (this.state == 1) {
                if (this.y > 1) {
                    return this.x > 0 && posList[this.x][this.y - 2] == 0 && 
                           posList[this.x][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0 &&
                           posList[this.x - 1][this.y - 2] == 0;
                }
                else if (this.y > 0) {
                    return this.x > 0 && posList[this.x][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0;
                }
                else {
                    return this.x > 0 && posList[this.x][this.y] == 0;
                }
            }
            else if (this.state == 2) {
                if (this.y > 0) {
                    return this.x > 0 && this.x < 9 && posList[this.x - 1][this.y] == 0 && 
                           posList[this.x][this.y] == 0 && 
                           posList[this.x + 1][this.y] == 0 &&
                           posList[this.x + 1][this.y - 1] == 0;
                }
                else {
                    return this.x > 0 && this.x < 9 && posList[this.x - 1][this.y] == 0 && 
                           posList[this.x][this.y] == 0 && 
                           posList[this.x + 1][this.y] == 0;
                }
            }
            else {
                if (this.y > 1) {
                    return this.x < 9 && posList[this.x][this.y - 2] == 0 && 
                           posList[this.x][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0 &&
                           posList[this.x + 1][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x < 9 && posList[this.x][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0 &&
                           posList[this.x + 1][this.y] == 0;
                }
                else {
                    return this.x < 9 && posList[this.x][this.y] == 0 &&
                           posList[this.x + 1][this.y] == 0;
                }
            }
        };
        SevenL.prototype.draw = function (ctx) {
            ctx.save();
            ctx.fillStyle = this.color;

            if (this.state == 0) {
                ctx.fillRect((this.x - 1) * 16 + 1, (this.y - 2) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, (this.y - 2) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, this.y * 16 + 1, 14, 14);
            }
            else if (this.state == 1) {
                ctx.fillRect((this.x + 1) * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect((this.x + 1) * 16 + 1, this.y * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, this.y * 16 + 1, 14, 14);
                ctx.fillRect((this.x - 1) * 16 + 1, this.y * 16 + 1, 14, 14);
            }
            else if (this.state == 2) {
                ctx.fillRect(this.x * 16 + 1, (this.y - 2) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, this.y * 16 + 1, 14, 14);
                ctx.fillRect((this.x + 1) * 16 + 1, this.y * 16 + 1, 14, 14);
            }
            else {
                ctx.fillRect((this.x - 1) * 16 + 1, this.y * 16 + 1, 14, 14);
                ctx.fillRect((this.x - 1) * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect((this.x + 1) * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
            }
                
            ctx.restore();
        }
        SevenL.prototype.canDown = function (posList) {
            if (this.state == 0) {
                if (this.y > 0) {
                    return this.y < 19 && posList[this.x - 1][this.y - 1] == 0 && 
                           posList[this.x][this.y + 1] == 0;
                }
                else {
                    return this.y < 19 && posList[this.x][this.y + 1] == 0;
                }
            }
            else if (this.state == 1) {
                return this.y < 19 && posList[this.x - 1][this.y + 1] == 0 && 
                       posList[this.x][this.y + 1] == 0 && 
                       posList[this.x + 1][this.y + 1] == 0;
            }
            else if (this.state == 2) {
                return this.y < 19 && posList[this.x + 1][this.y + 1] == 0 && 
                       posList[this.x][this.y + 1] == 0;
            }
            else {
                return this.y < 19 && posList[this.x - 1][this.y + 1] == 0 && 
                       posList[this.x][this.y] == 0 && 
                       posList[this.x + 1][this.y] == 0;
            }
        };
        SevenL.prototype.canLeft = function (posList) {
            if (this.state == 0) {
                if (this.y > 1) {
                    return this.x > 1 && posList[this.x - 2][this.y - 2] == 0 && 
                           posList[this.x - 1][this.y - 1] == 0 && 
                           posList[this.x - 1][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x > 1 && posList[this.x - 1][this.y - 1] == 0 && 
                           posList[this.x - 1][this.y] == 0;
                }
                else {
                    return this.x > 1 && posList[this.x - 1][this.y] == 0;
                }
            }
            else if (this.state == 1) {
                if (this.y > 0) {
                    return this.x > 1 && posList[this.x][this.y - 1] == 0 && 
                           posList[this.x - 2][this.y] == 0;
                }
                else {
                    return this.x > 1 && posList[this.x - 2][this.y] == 0;
                }
            }
            else if (this.state == 2) {
                if (this.y > 1) {
                    return this.x > 0 && posList[this.x - 1][this.y - 2] == 0 && 
                           posList[this.x - 1][this.y - 1] == 0 && 
                           posList[this.x - 1][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x > 0 && posList[this.x - 1][this.y - 1] == 0 && 
                           posList[this.x - 1][this.y] == 0;
                }
                else {
                    return this.x > 0 && posList[this.x - 1][this.y] == 0;
                }
            }
            else {
                if (this.y > 0) {
                    return this.x > 1 && posList[this.x - 2][this.y - 1] == 0 && 
                           posList[this.x - 2][this.y] == 0;
                }
                else {
                    return this.x > 1 && posList[this.x - 2][this.y] == 0;
                }
            }
        };
        SevenL.prototype.canRight = function (posList) {
            if (this.state == 0) {
                if (this.y > 1) {
                    return this.x < 9 && posList[this.x + 1][this.y - 2] == 0 && 
                           posList[this.x + 1][this.y - 1] == 0 && 
                           posList[this.x + 1][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x < 9 && posList[this.x + 1][this.y - 1] == 0 && 
                           posList[this.x + 1][this.y] == 0;
                }
                else {
                    return this.x < 9 && posList[this.x + 1][this.y] == 0;
                }
            }
            else if (this.state == 1) {
                if (this.y > 0) {
                    return this.x < 8 && posList[this.x + 2][this.y - 1] == 0 && 
                           posList[this.x + 2][this.y] == 0;
                }
                else {
                    return this.x < 8 && posList[this.x + 2][this.y] == 0;
                }
            }
            else if (this.state == 2) {
                if (this.y > 1) {
                    return this.x < 8 && posList[this.x + 1][this.y - 2] == 0 && 
                           posList[this.x + 1][this.y - 1] == 0 && 
                           posList[this.x + 2][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x < 8 && posList[this.x + 1][this.y - 1] == 0 && 
                           posList[this.x + 2][this.y] == 0;
                }
                else {
                    return this.x < 8 && posList[this.x + 2][this.y] == 0;
                }
            }
            else {
                if (this.y > 0) {
                    return this.x < 8 && posList[this.x + 2][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0;
                }
                else {
                    return this.x < 8 && posList[this.x][this.y] == 0;
                }
            }
        };
        SevenL.prototype.canChangeToList = function (posList) {
            if (this.state == 0) {
                return this.y > 1;
            }
            else if (this.state == 1) {
                return this.y > 0;
            }
            else if (this.state == 2) {
                return this.y > 1;
            }
            else {
                return this.y > 0;
            }
        };
        SevenL.prototype.changeToList = function (posList) {
            if (this.state == 0) {
                posList[this.x - 1][this.y - 2] = 3;
                posList[this.x][this.y - 2] = 3;
                posList[this.x][this.y - 1] = 3;
                posList[this.x][this.y] = 3;
            }
            else if (this.state == 1) {
                posList[this.x + 1][this.y - 1] = 3;
                posList[this.x + 1][this.y] = 3;
                posList[this.x][this.y] = 3;
                posList[this.x - 1][this.y] = 3;
            }
            else if (this.state == 2) {
                posList[this.x][this.y - 2] = 3;
                posList[this.x][this.y - 1] = 3;
                posList[this.x][this.y] = 3;
                posList[this.x + 1][this.y] = 3;
            }
            else {
                posList[this.x - 1][this.y] = 3;
                posList[this.x - 1][this.y - 1] = 3;
                posList[this.x][this.y - 1] = 3;
                posList[this.x + 1][this.y - 1] = 3;
            }
        };
    </script>
    <script>
        function SevenR(x, y, state) {
            this.x = x;
            this.y = y;
            this.color = "#f3cd22";
            this.state = state || 0;
        }
        SevenR.prototype = Object.create(squareBase);
        SevenR.prototype.constructor = SevenR;
        SevenR.prototype.canRotateLeft = function (posList) {
            if (this.state == 0) {
                if (this.y > 0) {
                    return this.x > 0 && this.x < 9 && 
                           posList[this.x - 1][this.y - 1] == 0 && 
                           posList[this.x][this.y - 1] == 0 && 
                           posList[this.x + 1][this.y - 1] == 0 &&
                           posList[this.x + 1][this.y] == 0;
                }
                else {
                    return this.x > 0 && this.x < 9 && 
                           posList[this.x + 1][this.y] == 0;
                }
            }
            else if (this.state == 1) {
                if (this.y > 1) {
                    return this.x < 9 && posList[this.x][this.y - 2] == 0 && 
                           posList[this.x][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0 &&
                           posList[this.x - 1][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x < 9 && posList[this.x][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0 &&
                           posList[this.x - 1][this.y] == 0;
                }
                else {
                    return this.x < 9 && posList[this.x][this.y] == 0 &&
                           posList[this.x - 1][this.y] == 0;
                }
            }
            else if (this.state == 2) {
                if (this.y > 0) {
                    return this.x > 0 && this.x < 9 && posList[this.x - 1][this.y] == 0 && 
                           posList[this.x][this.y] == 0 && 
                           posList[this.x + 1][this.y] == 0 &&
                           posList[this.x - 1][this.y - 1] == 0;
                }
                else {
                    return this.x > 0 && this.x < 9 && posList[this.x - 1][this.y] == 0 && 
                           posList[this.x][this.y] == 0 && 
                           posList[this.x + 1][this.y] == 0;
                }
            }
            else {
                if (this.y > 1) {
                    return this.x > 0 &&  posList[this.x][this.y - 2] == 0 && 
                           posList[this.x][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0 &&
                           posList[this.x + 1][this.y - 2] == 0;
                }
                else if (this.y > 0) {
                    return this.x > 0 && posList[this.x][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0;
                }
                else {
                    return this.x > 0 && posList[this.x][this.y] == 0;
                }
            }
        };
        SevenR.prototype.canRotateRight = function (posList) {
            if (this.state == 0) {
                if (this.y > 0) {
                    return this.x > 0 && this.x < 9 && posList[this.x - 1][this.y] == 0 && 
                           posList[this.x][this.y] == 0 && 
                           posList[this.x + 1][this.y] == 0 &&
                           posList[this.x - 1][this.y - 1] == 0;
                }
                else {
                    return this.x > 0 && this.x < 9 && posList[this.x - 1][this.y] == 0 && 
                           posList[this.x][this.y] == 0 && 
                           posList[this.x + 1][this.y] == 0;
                }
            }
            else if (this.state == 1) {
                if (this.y > 1) {
                    return this.x > 0 &&  posList[this.x][this.y - 2] == 0 && 
                           posList[this.x][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0 &&
                           posList[this.x + 1][this.y - 2] == 0;
                }
                else if (this.y > 0) {
                    return this.x > 0 && posList[this.x][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0;
                }
                else {
                    return this.x > 0 && posList[this.x][this.y] == 0;
                }
            }
            else if (this.state == 2) {
                if (this.y > 0) {
                    return this.x > 0 && this.x < 9 && 
                           posList[this.x - 1][this.y - 1] == 0 && 
                           posList[this.x][this.y - 1] == 0 && 
                           posList[this.x + 1][this.y - 1] == 0 &&
                           posList[this.x + 1][this.y] == 0;
                }
                else {
                    return this.x > 0 && this.x < 9 && 
                           posList[this.x + 1][this.y] == 0;
                }
            }
            else {
                if (this.y > 1) {
                    return this.x < 9 && posList[this.x][this.y - 2] == 0 && 
                           posList[this.x][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0 &&
                           posList[this.x - 1][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x < 9 && posList[this.x][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0 &&
                           posList[this.x - 1][this.y] == 0;
                }
                else {
                    return this.x < 9 && posList[this.x][this.y] == 0 &&
                           posList[this.x - 1][this.y] == 0;
                }
            }
        };
        SevenR.prototype.draw = function (ctx) {
            ctx.save();
            ctx.fillStyle = this.color;

            if (this.state == 0) {
                ctx.fillRect((this.x + 1) * 16 + 1, (this.y - 2) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, (this.y - 2) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, this.y * 16 + 1, 14, 14);
            }
            else if (this.state == 1) {
                ctx.fillRect((this.x + 1) * 16 + 1, this.y * 16 + 1, 14, 14);
                ctx.fillRect((this.x + 1) * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect((this.x - 1) * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
            }
            else if (this.state == 2) {
                ctx.fillRect(this.x * 16 + 1, (this.y - 2) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, this.y * 16 + 1, 14, 14);
                ctx.fillRect((this.x - 1) * 16 + 1, this.y * 16 + 1, 14, 14);
            }
            else {
                ctx.fillRect((this.x - 1) * 16 + 1, this.y * 16 + 1, 14, 14);
                ctx.fillRect((this.x - 1) * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, this.y * 16 + 1, 14, 14);
                ctx.fillRect((this.x + 1) * 16 + 1, this.y * 16 + 1, 14, 14);
            }
                
            ctx.restore();
        }
        SevenR.prototype.canDown = function (posList) {
            if (this.state == 0) {
                if (this.y > 0) {
                    return this.y < 19 && posList[this.x + 1][this.y - 1] == 0 && 
                           posList[this.x][this.y + 1] == 0;
                }
                else {
                    return this.y < 19 && posList[this.x][this.y + 1] == 0;
                }
            }
            else if (this.state == 1) {
                return this.y < 19 && posList[this.x + 1][this.y + 1] == 0 && 
                       posList[this.x][this.y] == 0 && 
                       posList[this.x - 1][this.y] == 0;
            }
            else if (this.state == 2) {
                return this.y < 19 && posList[this.x - 1][this.y + 1] == 0 && 
                       posList[this.x][this.y + 1] == 0;
            }
            else {
                return this.y < 19 && posList[this.x - 1][this.y + 1] == 0 && 
                       posList[this.x][this.y + 1] == 0 && 
                       posList[this.x + 1][this.y + 1] == 0;
            }
        };
        SevenR.prototype.canLeft = function (posList) {
            if (this.state == 0) {
                if (this.y > 1) {
                    return this.x > 0 && posList[this.x - 1][this.y - 2] == 0 && 
                           posList[this.x - 1][this.y - 1] == 0 && 
                           posList[this.x - 1][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x > 0 && posList[this.x - 1][this.y - 1] == 0 && 
                           posList[this.x - 1][this.y] == 0;
                }
                else {
                    return this.x > 0 && posList[this.x - 1][this.y] == 0;
                }
            }
            else if (this.state == 1) {
                if (this.y > 0) {
                    return this.x > 1 && posList[this.x][this.y] == 0 && 
                           posList[this.x - 2][this.y - 1] == 0;
                }
                else {
                    return this.x > 1 && posList[this.x][this.y] == 0;
                }
            }
            else if (this.state == 2) {
                if (this.y > 1) {
                    return this.x > 1 && posList[this.x - 1][this.y - 2] == 0 && 
                           posList[this.x - 1][this.y - 1] == 0 && 
                           posList[this.x - 2][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x > 1 && posList[this.x - 1][this.y - 1] == 0 && 
                           posList[this.x - 2][this.y] == 0;
                }
                else {
                    return this.x > 1 && posList[this.x - 2][this.y] == 0;
                }
            }
            else {
                if (this.y > 0) {
                    return this.x > 1 && posList[this.x - 2][this.y - 1] == 0 && 
                           posList[this.x - 2][this.y] == 0;
                }
                else {
                    return this.x > 1 && posList[this.x - 2][this.y] == 0;
                }
            }
        };
        SevenR.prototype.canRight = function (posList) {
            if (this.state == 0) {
                if (this.y > 1) {
                    return this.x < 8 && posList[this.x + 2][this.y - 2] == 0 && 
                           posList[this.x + 1][this.y - 1] == 0 && 
                           posList[this.x + 1][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x < 8 && posList[this.x + 1][this.y - 1] == 0 && 
                           posList[this.x + 1][this.y] == 0;
                }
                else {
                    return this.x < 8 && posList[this.x + 1][this.y] == 0;
                }
            }
            else if (this.state == 1) {
                if (this.y > 0) {
                    return this.x < 8 && posList[this.x + 2][this.y - 1] == 0 && 
                           posList[this.x + 2][this.y] == 0;
                }
                else {
                    return this.x < 8 && posList[this.x + 2][this.y] == 0;
                }
            }
            else if (this.state == 2) {
                if (this.y > 1) {
                    return this.x < 9 && posList[this.x + 1][this.y - 2] == 0 && 
                           posList[this.x + 1][this.y - 1] == 0 && 
                           posList[this.x + 1][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x < 9 && posList[this.x + 1][this.y - 1] == 0 && 
                           posList[this.x + 1][this.y] == 0;
                }
                else {
                    return this.x < 9 && posList[this.x + 1][this.y] == 0;
                }
            }
            else {
                if (this.y > 0) {
                    return this.x < 8 && posList[this.x + 2][this.y] == 0 && 
                           posList[this.x][this.y - 1] == 0;
                }
                else {
                    return this.x < 8 && posList[this.x + 2][this.y] == 0;
                }
            }
        };
        SevenR.prototype.canChangeToList = function (posList) {
            if (this.state == 0) {
                return this.y > 1;
            }
            else if (this.state == 1) {
                return this.y > 0;
            }
            else if (this.state == 2) {
                return this.y > 1;
            }
            else {
                return this.y > 0;
            }
        };
        SevenR.prototype.changeToList = function (posList) {
            if (this.state == 0) {
                posList[this.x + 1][this.y - 2] = 4;
                posList[this.x][this.y - 2] = 4;
                posList[this.x][this.y - 1] = 4;
                posList[this.x][this.y] = 4;
            }
            else if (this.state == 1) {
                posList[this.x + 1][this.y] = 4;
                posList[this.x + 1][this.y - 1] = 4;
                posList[this.x][this.y - 1] = 4;
                posList[this.x - 1][this.y - 1] = 4;
            }
            else if (this.state == 2) {
                posList[this.x][this.y - 2] = 4;
                posList[this.x][this.y - 1] = 4;
                posList[this.x][this.y] = 4;
                posList[this.x - 1][this.y] = 4;
            }
            else {
                posList[this.x - 1][this.y - 1] = 4;
                posList[this.x - 1][this.y] = 4;
                posList[this.x][this.y] = 4;
                posList[this.x + 1][this.y] = 4;
            }
        };
    </script>
    <script>
        function ZquareL(x, y, state) {
            this.x = x;
            this.y = y;
            this.color = "#df2fa3";
            this.state = state > 1 ? 1 : 0;
        }

        ZquareL.prototype = Object.create(squareBase);
        ZquareL.prototype.constructor = ZquareL;
        ZquareL.prototype.rotateLeft = function () {
            if (this.state == 0) this.state = 1;
            else this.state = 0;
        };
        ZquareL.prototype.rotateRight = function () {
            this.rotateLeft();
        };
        ZquareL.prototype.canRotateLeft = function (posList) {
            if (this.state == 0) {
                if (this.y > 0) {
                    return this.x > 0 && this.x < 9 && 
                           posList[this.x + 1][this.y - 1] == 0 && 
                           posList[this.x][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0 &&
                           posList[this.x - 1][this.y] == 0;
                }
                else {
                    return this.x > 0 && this.x < 9 && 
                           posList[this.x][this.y] == 0 &&
                           posList[this.x - 1][this.y] == 0;
                }
            }
            else {
                if (this.y > 1) {
                    return this.x > 0 && this.x < 9 && 
                           posList[this.x][this.y - 2] == 0 && 
                           posList[this.x][this.y - 1] == 0 && 
                           posList[this.x + 1][this.y - 1] == 0 &&
                           posList[this.x + 1][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x > 0 && this.x < 9 && 
                           posList[this.x][this.y - 1] == 0 && 
                           posList[this.x + 1][this.y - 1] == 0 &&
                           posList[this.x + 1][this.y] == 0;
                }
                else {
                    return this.x > 0 && this.x < 9 && 
                           posList[this.x + 1][this.y] == 0;
                }
            }
        };
        ZquareL.prototype.canRotateRight = function (posList) {
            return this.canRotateLeft(posList);
        };
        ZquareL.prototype.draw = function (ctx) {
            ctx.save();
            ctx.fillStyle = this.color;

            if (this.state == 0) {
                ctx.fillRect(this.x * 16 + 1, (this.y - 2) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect((this.x + 1) * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect((this.x + 1) * 16 + 1, this.y * 16 + 1, 14, 14);
            }
            else {
                ctx.fillRect((this.x + 1) * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, this.y * 16 + 1, 14, 14);
                ctx.fillRect((this.x - 1) * 16 + 1, this.y * 16 + 1, 14, 14);
            }
                
            ctx.restore();
        }
        ZquareL.prototype.canDown = function (posList) {
            if (this.state == 0) {
                return this.y < 19 && posList[this.x][this.y] == 0 && 
                        posList[this.x + 1][this.y + 1] == 0;
            }
            else {
                return this.y < 19 && posList[this.x - 1][this.y + 1] == 0 && 
                    posList[this.x][this.y + 1] == 0 && 
                    posList[this.x + 1][this.y] == 0;
            }
        };
        ZquareL.prototype.canLeft = function (posList) {
            if (this.state == 0) {
                if (this.y > 1) {
                    return this.x > 0 && posList[this.x - 1][this.y - 2] == 0 && 
                           posList[this.x - 1][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x > 0 && posList[this.x - 1][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0;
                }
                else {
                    return this.x > 0 && posList[this.x][this.y] == 0;
                }
            }
            else {
                if (this.y > 0) {
                    return this.x > 1 && posList[this.x - 1][this.y - 1] == 0 && 
                           posList[this.x - 2][this.y] == 0;
                }
                else {
                    return this.x > 1 && posList[this.x - 2][this.y] == 0;;
                }
            }
        };
        ZquareL.prototype.canRight = function (posList) {
            if (this.state == 0) {
                if (this.y > 1) {
                    return this.x < 8 && posList[this.x + 1][this.y - 2] == 0 && 
                           posList[this.x + 2][this.y - 1] == 0 && 
                           posList[this.x + 2][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x < 8 && posList[this.x + 2][this.y - 1] == 0 && 
                           posList[this.x + 2][this.y] == 0;
                }
                else {
                    return this.x < 8 && posList[this.x + 2][this.y] == 0;
                }
            }
            else {
                if (this.y > 0) {
                    return this.x < 8 && posList[this.x + 2][this.y - 1] == 0 && 
                           posList[this.x + 1][this.y] == 0;
                }
                else {
                    return this.x < 8 && posList[this.x + 1][this.y] == 0;
                }
            }
        };
        ZquareL.prototype.canChangeToList = function (posList) {
            if (this.state == 0) {
                return this.y > 1;
            }
            else {
                return this.y > 0;
            }
        };
        ZquareL.prototype.changeToList = function (posList) {
            if (this.state == 0) {
                posList[this.x][this.y - 2] = 5;
                posList[this.x][this.y - 1] = 5;
                posList[this.x + 1][this.y - 1] = 5;
                posList[this.x + 1][this.y] = 5;
            }
            else {
                posList[this.x + 1][this.y - 1] = 5;
                posList[this.x][this.y - 1] = 5;
                posList[this.x][this.y] = 5;
                posList[this.x - 1][this.y] = 5;
            }
        };
    </script>
    <script>
        function ZquareR(x, y, state) {
            this.x = x;
            this.y = y;
            this.color = "#3f56a3";
            this.state = state > 1 ? 1 : 0;
        }

        ZquareR.prototype = Object.create(squareBase);
        ZquareR.prototype.constructor = ZquareR;
        ZquareR.prototype.rotateLeft = function () {
            if (this.state == 0) this.state = 1;
            else this.state = 0;
        };
        ZquareR.prototype.rotateRight = function () {
            this.rotateLeft();
        };
        ZquareR.prototype.canRotateLeft = function (posList) {
            if (this.state == 0) {
                if (this.y > 0) {
                    return this.x > 0 && this.x < 9 && 
                           posList[this.x - 1][this.y - 1] == 0 && 
                           posList[this.x][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0 &&
                           posList[this.x + 1][this.y] == 0;
                }
                else {
                    return this.x > 0 && this.x < 9 && 
                           posList[this.x][this.y] == 0 &&
                           posList[this.x + 1][this.y] == 0;
                }
            }
            else {
                if (this.y > 1) {
                    return this.x > 0 && this.x < 9 && 
                           posList[this.x][this.y - 2] == 0 && 
                           posList[this.x][this.y - 1] == 0 && 
                           posList[this.x - 1][this.y - 1] == 0 &&
                           posList[this.x - 1][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x > 0 && this.x < 9 && 
                           posList[this.x][this.y - 1] == 0 && 
                           posList[this.x - 1][this.y - 1] == 0 &&
                           posList[this.x - 1][this.y] == 0;
                }
                else {
                    return this.x > 0 && this.x < 9 && 
                           posList[this.x - 1][this.y] == 0;
                }
            }
        };
        ZquareR.prototype.canRotateRight = function (posList) {
            return this.canRotateLeft(posList);
        };
        ZquareR.prototype.draw = function (ctx) {
            ctx.save();
            ctx.fillStyle = this.color;

            if (this.state == 0) {
                ctx.fillRect(this.x * 16 + 1, (this.y - 2) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect((this.x - 1) * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect((this.x - 1) * 16 + 1, this.y * 16 + 1, 14, 14);
            }
            else {
                ctx.fillRect((this.x + 1) * 16 + 1, this.y * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, this.y * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect((this.x - 1) * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
            }
                
            ctx.restore();
        }
        ZquareR.prototype.canDown = function (posList) {
            if (this.state == 0) {
                return this.y < 19 && posList[this.x][this.y] == 0 && 
                        posList[this.x - 1][this.y + 1] == 0;
            }
            else {
                return this.y < 19 && posList[this.x - 1][this.y] == 0 && 
                    posList[this.x][this.y + 1] == 0 && 
                    posList[this.x + 1][this.y + 1] == 0;
            }
        };
        ZquareR.prototype.canLeft = function (posList) {
            if (this.state == 0) {
                if (this.y > 1) {
                    return this.x > 1 && posList[this.x - 1][this.y - 2] == 0 && 
                           posList[this.x - 2][this.y - 1] == 0 && 
                           posList[this.x - 2][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x > 1 && posList[this.x - 2][this.y - 1] == 0 && 
                           posList[this.x - 2][this.y] == 0;
                }
                else {
                    return this.x > 1 && posList[this.x - 2][this.y] == 0;
                }
            }
            else {
                if (this.y > 0) {
                    return this.x > 1 && posList[this.x - 2][this.y - 1] == 0 && 
                           posList[this.x - 1][this.y] == 0;
                }
                else {
                    return this.x > 1 && posList[this.x - 1][this.y] == 0;;
                }
            }
        };
        ZquareR.prototype.canRight = function (posList) {
            if (this.state == 0) {
                if (this.y > 1) {
                    return this.x < 9 && posList[this.x + 1][this.y - 2] == 0 && 
                           posList[this.x + 1][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x < 9 && posList[this.x + 1][this.y - 1] == 0 && 
                           posList[this.x][this.y] == 0;
                }
                else {
                    return this.x < 9 && posList[this.x][this.y] == 0;
                }
            }
            else {
                if (this.y > 0) {
                    return this.x < 8 && posList[this.x + 2][this.y] == 0 && 
                           posList[this.x + 1][this.y - 1] == 0;
                }
                else {
                    return this.x < 8 && posList[this.x + 1][this.y - 1] == 0;
                }
            }
        };
        ZquareR.prototype.canChangeToList = function (posList) {
            if (this.state == 0) {
                return this.y > 1;
            }
            else {
                return this.y > 0;
            }
        };
        ZquareR.prototype.changeToList = function (posList) {
            if (this.state == 0) {
                posList[this.x][this.y - 2] = 6;
                posList[this.x][this.y - 1] = 6;
                posList[this.x - 1][this.y - 1] = 6;
                posList[this.x - 1][this.y] = 6;
            }
            else {
                posList[this.x + 1][this.y] = 6;
                posList[this.x][this.y] = 6;
                posList[this.x][this.y - 1] = 6;
                posList[this.x - 1][this.y - 1] = 6;
            }
        };
    </script>
    <script>
        function Tquare(x, y, state) {
            this.x = x;
            this.y = y;
            this.color = "#3ffff3";
            this.state = state || 0;
        }

        Tquare.prototype = Object.create(squareBase);
        Tquare.prototype.constructor = Tquare;
        Tquare.prototype.canRotateLeft = function (posList) {
            if (this.state == 0) {
                if (this.y > 0) {
                    return this.x > 0 && this.x < 9 && 
                            posList[this.x][this.y - 1] == 0 && 
                            posList[this.x][this.y] == 0 && 
                            posList[this.x - 1][this.y] == 0 &&
                            posList[this.x + 1][this.y] == 0;
                }
                else {
                    return this.x > 0 && this.x < 9 && 
                            posList[this.x][this.y] == 0 && 
                            posList[this.x - 1][this.y] == 0 &&
                            posList[this.x + 1][this.y] == 0;
                }
            }
            else if (this.state == 1) {
                if (this.y > 1) {
                    return this.x > 0 && 
                            posList[this.x - 1][this.y - 2] == 0 && 
                            posList[this.x - 1][this.y - 1] == 0 && 
                            posList[this.x - 1][this.y] == 0 &&
                            posList[this.x][this.y - 1] == 0;
                }
                else if (this.y > 0) {
                    return this.x > 0 &&
                            posList[this.x - 1][this.y - 1] == 0 && 
                            posList[this.x - 1][this.y] == 0 &&
                            posList[this.x][this.y - 1] == 0;
                }
                else {
                    return this.x > 0 && posList[this.x - 1][this.y] == 0;
                }
            }
            else if (this.state == 2) {
                if (this.y > 0) {
                    return this.x > 0 && this.x < 9 && posList[this.x - 1][this.y - 1] == 0 && 
                            posList[this.x][this.y - 1] == 0 && 
                            posList[this.x][this.y] == 0 &&
                            posList[this.x + 1][this.y - 1] == 0;
                }
                else {
                    return this.x > 0 && this.x < 9 && posList[this.x][this.y] == 0;
                }
            }
            else {
                if (this.y > 1) {
                    return this.x < 9 &&  
                            posList[this.x + 1][this.y - 2] == 0 && 
                            posList[this.x + 1][this.y - 1] == 0 && 
                            posList[this.x][this.y - 1] == 0 &&
                            posList[this.x + 1][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x < 9 && 
                            posList[this.x + 1][this.y - 1] == 0 && 
                            posList[this.x][this.y - 1] == 0 &&
                            posList[this.x + 1][this.y] == 0;
                }
                else {
                    return this.x < 9 && posList[this.x + 1][this.y] == 0;
                }
            }
        };
        Tquare.prototype.canRotateRight = function (posList) {
            if (this.state == 2) {
                if (this.y > 0) {
                    return this.x > 0 && this.x < 9 && 
                            posList[this.x][this.y - 1] == 0 && 
                            posList[this.x][this.y] == 0 && 
                            posList[this.x - 1][this.y] == 0 &&
                            posList[this.x + 1][this.y] == 0;
                }
                else {
                    return this.x > 0 && this.x < 9 && 
                            posList[this.x][this.y] == 0 && 
                            posList[this.x - 1][this.y] == 0 &&
                            posList[this.x + 1][this.y] == 0;
                }
            }
            else if (this.state == 3) {
                if (this.y > 1) {
                    return this.x > 0 && 
                            posList[this.x - 1][this.y - 2] == 0 && 
                            posList[this.x - 1][this.y - 1] == 0 && 
                            posList[this.x - 1][this.y] == 0 &&
                            posList[this.x][this.y - 1] == 0;
                }
                else if (this.y > 0) {
                    return this.x > 0 &&
                            posList[this.x - 1][this.y - 1] == 0 && 
                            posList[this.x - 1][this.y] == 0 &&
                            posList[this.x][this.y - 1] == 0;
                }
                else {
                    return this.x > 0 && posList[this.x - 1][this.y] == 0;
                }
            }
            else if (this.state == 0) {
                if (this.y > 0) {
                    return this.x > 0 && this.x < 9 && posList[this.x - 1][this.y - 1] == 0 && 
                            posList[this.x][this.y - 1] == 0 && 
                            posList[this.x][this.y] == 0 &&
                            posList[this.x + 1][this.y - 1] == 0;
                }
                else {
                    return this.x > 0 && this.x < 9 && posList[this.x][this.y] == 0;
                }
            }
            else {
                if (this.y > 1) {
                    return this.x < 9 &&  
                            posList[this.x + 1][this.y - 2] == 0 && 
                            posList[this.x + 1][this.y - 1] == 0 && 
                            posList[this.x][this.y - 1] == 0 &&
                            posList[this.x + 1][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x < 9 && 
                            posList[this.x + 1][this.y - 1] == 0 && 
                            posList[this.x][this.y - 1] == 0 &&
                            posList[this.x + 1][this.y] == 0;
                }
                else {
                    return this.x < 9 && posList[this.x + 1][this.y] == 0;
                }
            }
        };
        Tquare.prototype.draw = function (ctx) {
            ctx.save();
            ctx.fillStyle = this.color;

            if (this.state == 0) {
                ctx.fillRect((this.x + 1) * 16 + 1, (this.y - 2) * 16 + 1, 14, 14);
                ctx.fillRect((this.x + 1) * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect((this.x + 1) * 16 + 1, this.y * 16 + 1, 14, 14);
            }
            else if (this.state == 1) {
                ctx.fillRect((this.x + 1) * 16 + 1, this.y * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, this.y * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect((this.x - 1) * 16 + 1, this.y * 16 + 1, 14, 14);
            }
            else if (this.state == 2) {
                ctx.fillRect((this.x - 1) * 16 + 1, (this.y - 2) * 16 + 1, 14, 14);
                ctx.fillRect((this.x - 1) * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect((this.x - 1) * 16 + 1, this.y * 16 + 1, 14, 14);
            }
            else {
                ctx.fillRect((this.x - 1) * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
                ctx.fillRect(this.x * 16 + 1, this.y * 16 + 1, 14, 14);
                ctx.fillRect((this.x + 1) * 16 + 1, (this.y - 1) * 16 + 1, 14, 14);
            }
                
            ctx.restore();
        }
        Tquare.prototype.canDown = function (posList) {
            if (this.state == 0) {
                if (this.y > 0) {
                    return this.y < 19 && posList[this.x + 1][this.y + 1] == 0 && 
                            posList[this.x][this.y] == 0;
                }
                else {
                    return posList[this.x + 1][this.y + 1] == 0;
                }
            }
            else if (this.state == 1) {
                return this.y < 19 && posList[this.x + 1][this.y + 1] == 0 && 
                        posList[this.x][this.y + 1] == 0 && 
                        posList[this.x - 1][this.y + 1] == 0;
            }
            else if (this.state == 2) {
                return this.y < 19 && posList[this.x - 1][this.y + 1] == 0 && 
                        posList[this.x][this.y] == 0;
            }
            else {
                return this.y < 19 && posList[this.x - 1][this.y] == 0 && 
                        posList[this.x][this.y + 1] == 0 && 
                        posList[this.x + 1][this.y] == 0;
            }
        };
        Tquare.prototype.canLeft = function (posList) {
            if (this.state == 0) {
                if (this.y > 1) {
                    return this.x > 0 && posList[this.x][this.y - 2] == 0 && 
                            posList[this.x - 1][this.y - 1] == 0 && 
                            posList[this.x][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x > 0 && posList[this.x - 1][this.y - 1] == 0 && 
                            posList[this.x][this.y] == 0;
                }
                else {
                    return this.x > 0 && posList[this.x][this.y] == 0;
                }
            }
            else if (this.state == 1) {
                if (this.y > 0) {
                    return this.x > 1 && posList[this.x - 1][this.y - 1] == 0 && 
                            posList[this.x - 2][this.y] == 0;
                }
                else {
                    return this.x > 1 && posList[this.x - 2][this.y] == 0;
                }
            }
            else if (this.state == 2) {
                if (this.y > 1) {
                    return this.x > 1 && posList[this.x - 2][this.y - 2] == 0 && 
                            posList[this.x - 2][this.y - 1] == 0 && 
                            posList[this.x - 2][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x > 1 && posList[this.x - 2][this.y - 1] == 0 && 
                            posList[this.x - 2][this.y] == 0;
                }
                else {
                    return this.x > 1 && posList[this.x - 2][this.y] == 0;
                }
            }
            else {
                if (this.y > 0) {
                    return this.x > 1 && posList[this.x - 2][this.y - 1] == 0 && 
                            posList[this.x - 1][this.y] == 0;
                }
                else {
                    return this.x > 1 && posList[this.x - 1][this.y] == 0;
                }
            }
        };
        Tquare.prototype.canRight = function (posList) {
            if (this.state == 0) {
                if (this.y > 1) {
                    return this.x < 8 && posList[this.x + 2][this.y - 2] == 0 && 
                            posList[this.x + 2][this.y - 1] == 0 && 
                            posList[this.x + 2][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x < 8 && posList[this.x + 2][this.y - 1] == 0 && 
                            posList[this.x + 2][this.y] == 0;
                }
                else {
                    return this.x < 8 && posList[this.x + 2][this.y] == 0;
                }
            }
            else if (this.state == 1) {
                if (this.y > 0) {
                    return this.x < 8 && posList[this.x + 1][this.y - 1] == 0 && 
                            posList[this.x + 2][this.y] == 0;
                }
                else {
                    return this.x < 8 && posList[this.x + 2][this.y] == 0;
                }
            }
            else if (this.state == 2) {
                if (this.y > 1) {
                    return this.x < 9 && posList[this.x][this.y - 2] == 0 && 
                            posList[this.x + 1][this.y - 1] == 0 && 
                            posList[this.x][this.y] == 0;
                }
                else if (this.y > 0) {
                    return this.x < 9 && posList[this.x + 1][this.y - 1] == 0 && 
                            posList[this.x][this.y] == 0;
                }
                else {
                    return this.x < 9 && posList[this.x][this.y] == 0;
                }
            }
            else {
                if (this.y > 0) {
                    return this.x < 8 && posList[this.x + 2][this.y - 1] == 0 && 
                            posList[this.x + 1][this.y] == 0;
                }
                else {
                    return this.x < 8 && posList[this.x + 1][this.y] == 0;
                }
            }
        };
        Tquare.prototype.canChangeToList = function (posList) {
            if (this.state == 0) {
                return this.y > 1;
            }
            else if (this.state == 1) {
                return this.y > 0;
            }
            else if (this.state == 2) {
                return this.y > 1;
            }
            else {
                return this.y > 0;
            }
        };
        Tquare.prototype.changeToList = function (posList) {
            if (this.state == 0) {
                posList[this.x + 1][this.y - 2] = 7;
                posList[this.x + 1][this.y - 1] = 7;
                posList[this.x][this.y - 1] = 7;
                posList[this.x + 1][this.y] = 7;
            }
            else if (this.state == 1) {
                posList[this.x + 1][this.y] = 7;
                posList[this.x][this.y] = 7;
                posList[this.x][this.y - 1] = 7;
                posList[this.x - 1][this.y] = 7;
            }
            else if (this.state == 2) {
                posList[this.x - 1][this.y - 2] = 7;
                posList[this.x - 1][this.y - 1] = 7;
                posList[this.x - 1][this.y] = 7;
                posList[this.x][this.y - 1] = 7;
            }
            else {
                posList[this.x - 1][this.y - 1] = 7;
                posList[this.x][this.y - 1] = 7;
                posList[this.x + 1][this.y - 1] = 7;
                posList[this.x][this.y] = 7;
            }
        };
    </script>
    <script>
        function StopWatch() {
            this.startTime = 0;
            this.running = false;
            this.elapsedTime = 0;
        }
        StopWatch.prototype = {
            start: function () {
                this.startTime = +new Date();
                this.elapsedTime = 0;
                this.running = true;
            },
            stop: function () {
                this.elapsedTime = +new Date() - this.startTime;
                this.running = false;
            },
            resume: function () {
                this.running = true;
                this.startTime += this.elapsedTime;
            },
            getElapsedTime: function () {
                if (this.running) return +new Date() - this.startTime;
                else return this.elapsedTime;
            },
            reset: function() {
                this.elapsedTime = 0;
                this.startTime = 0;
                this.running = false;
            }
        };
    </script>
    <script>
        var teris = new function () {
            elapsed = 1500;
            stopWatch = new StopWatch();
            var squareType = {
                1: Line,
                2: Square,
                3: SevenL,
                4: SevenR,
                5: ZquareL,
                6: ZquareR,
                7: Tquare,
            };
            var activeSquare = null;
            var squareNextList = [
                randomType(),
                randomType(),
                randomType(),
                randomType(),
                randomType()
            ];
            var saveSquare = null;
            var log = console.log;
            var that = this;

            var terisColor = [
                "#eeeeee", "#00ff00", "#ff0000", "#f348e2", 
                "#f3cd22", "#df2fa3", "#3f56a3", "#3ffff3"
            ]

            var squareList = new Array(10);

            this.pauseGame = function () {
                if (stopWatch.running) {
                    stopWatch.stop();
                }
                else {
                    stopWatch.resume();
                }
            };

            this.setElapsed = function (i) {
                elapsed = 1500 * Math.pow(0.9, 1);
            };

            this.draw = function (ctx) {
                ctx.font = "12px arial";
                ctx.textBaseline = "top";
                ctx.textAlign = "center";
                ctx.save();
                
                ctx.fillText("save", 40, 30);
                ctx.beginPath();
                ctx.translate(10, 45);
                ctx.rect(0, 0, 60, 60);

                if (saveSquare) {
                    ctx.translate(25, 30);
                    ctx.scale(0.5, 0.5);
                    saveSquare.draw(ctx);
                }

                ctx.stroke();
                ctx.restore();

                ctx.save();
                
                ctx.fillText("quene", 40, 110);
                ctx.beginPath();
                ctx.translate(10, 125);
                ctx.rect(0, 0, 60, 215);
                ctx.translate(25, 30);
                ctx.scale(0.5, 0.5);
                for (var i = 0; i < squareNextList.length; i++) {
                    squareNextList[i].draw(ctx);
                    ctx.translate(0, 75);
                }
                ctx.stroke();
                ctx.restore();

                ctx.save();
                ctx.translate(80, 20);
                ctx.strokeStyle = "black";
                ctx.lineWidth = 1;
                ctx.strokeRect(0.5, 0.5, 160, 320);
                for (var i = 0; i < squareList.length; i++) {
                    for (var j = 0; j < squareList[i].length; j++) {
                        ctx.fillStyle = terisColor[squareList[i][j]];
                        ctx.fillRect(i * 16 + 1, j * 16 + 1, 14, 14);
                    }
                }

                if (activeSquare) {
                    if (stopWatch.getElapsedTime() > elapsed) {
                        this.squareDown();
                    }
                    drawSquare(ctx, activeSquare);
                }
                ctx.restore();

                if (!stopWatch.running) {
                    ctx.save();
                    ctx.font = "20px arial";
                    ctx.fillStyle = "red";
                    ctx.textAlign = "center";
                    ctx.fillText("paused", 160, 180);
                    ctx.restore();
                }
            };

            this.clickLeft = function () {
                if (!stopWatch.running) return;
                if (activeSquare && activeSquare.canLeft(squareList)) {
                    activeSquare.left();
                }
            };
            this.clickRight = function () {
                if (!stopWatch.running) return;
                if (activeSquare && activeSquare.canRight(squareList)) {
                    activeSquare.right();
                }
            };
            this.clickUp = function () {
                if (!stopWatch.running) return;
                if (activeSquare) {
                    while (activeSquare.canDown(squareList)) {
                        activeSquare.down();
                    }
                    if (!activeSquare.canChangeToList(squareList)) {
                        that.start();
                    }
                    else {
                        that.nextSquare();
                    }
                }
            };
            this.squareDown = function () {
                if (activeSquare) {
                    if (activeSquare.canDown(squareList)) {
                        activeSquare.down();
                        stopWatch.start();
                    }
                    else {
                        if (!activeSquare.canChangeToList(squareList)) {
                            this.start();
                        }
                        else {
                            this.nextSquare();
                        }
                    }
                }
            }
            this.nextSquare = function () {
                activeSquare.changeToList(squareList);
                activeSquare = squareNextList.pop();
                squareNextList.unshift(randomType());
                activeSquare.x = 4;
                stopWatch.start();
                checkSquareList();
            }
            this.clickDown = function () {
                if (!stopWatch.running) return;
                that.squareDown();
            };
            
            this.clickSave = function () {
                if (!stopWatch.running) return;
                if (saveSquare) {
                    var x = activeSquare.x, y = activeSquare.y;
                    var tempSquare = activeSquare.clone();
                    tempSquare.x = 0;
                    tempSquare.y = 0;

                    activeSquare = saveSquare;
                    activeSquare.x = x;
                    activeSquare.y = y;

                    saveSquare = tempSquare;
                }
                else {
                    saveSquare = activeSquare.clone();
                    saveSquare.x = 0;
                    saveSquare.y = 0;

                    activeSquare = squareNextList.pop();
                    squareNextList.unshift(randomType());
                    activeSquare.x = 4;
                }
            };
            this.clickRotateLeft = function () {
                if (!stopWatch.running) return;
                if (activeSquare && activeSquare.canRotateLeft(squareList)) {
                    activeSquare.rotateLeft();
                }
            };
            this.clickRotateRight = function () {
                if (!stopWatch.running) return;
                if (activeSquare && activeSquare.canRotateRight(squareList)) {
                    activeSquare.rotateRight();
                }
            };

            this.start = function () {
                for (var i = 0; i < squareList.length; i++) {
                    squareList[i] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                }
                stopWatch.start();
                activeSquare = squareNextList.pop();
                squareNextList.unshift(randomType());
                activeSquare.x = 4;
                saveSquare = null;
                player.start();
            };

            function checkSquareList() {
                var activeLines = [];
                for (var i = 0; i < 20; i++) {
                    var iActive = true;
                    for (var j = 0; j < 10; j++) {
                        iActive = iActive && squareList[j][i] !== 0;
                    }
                    if (iActive) {
                        activeLines.push(i);
                    }
                }
                
                var length = activeLines.length;
                if (length == 0) return;
                for (var j = 0; j < length; j++) {
                    var index = activeLines[j];
                    for (var i = 0; i < 10; i++) {
                        squareList[i].splice(index, 1);
                        squareList[i].unshift(0);
                    }
                }

                player.addLine(length);
            }

            function randomType() {
                return new squareType[parseInt(Math.random() * 7) + 1 + ""](0, 0, parseInt(Math.random() * 4));
            }

            function drawSquare(ctx, square) {
                ctx.beginPath();
                ctx.rect(0, 0, 160, 320);
                ctx.clip();
                square.draw(ctx);
            }
        }
    </script>
    <script>
        var player = new function () {
            var score = 0;
            var lines = 0;
            var level = 0;
            var time = null;
            var levelArray = [20, 50, 100, 300, 600, 1000, 1600, 2500, 3600, 4800, 6000, 7300, 8700, 10000];

            this.draw = function (ctx) {
                var elapsed = updateTime();
                ctx.save();
                ctx.font = "12px arial";
                ctx.textBaseline = "top";
                ctx.textAlign = "center";
                ctx.fillText("level:", 280, 30);
                ctx.fillText("lines:", 280, 94);
                ctx.fillText("score:", 280, 158);
                ctx.fillText("times:", 280, 222);

                ctx.fillText(level,  280, 50);
                ctx.fillText(lines, 280, 114);
                ctx.fillText(score,  280, 178);
                ctx.fillText(elapsed,  280, 242);
                
                ctx.restore();
            }

            this.addLine = function (num) {
                switch (num) {
                    case 1: 
                        score += 100;
                        break;
                    case 2: 
                        score += 300;
                        break;
                    case 3: 
                        score += 500;
                        break;
                    case 4: 
                        score += 1000;
                        break;
                    default: 
                        throw new Error("undefined Line");
                        break;
                }
                lines += num;
                updateLevel();
            };

            this.start = function () {
                score = 0;
                lines = 0;
                level = 0;
                time = Date.now();
            };

            function updateLevel() {
                var i;
                for (var i = 0; i < levelArray.length; i++) {
                    if (lines < levelArray[i]); break;
                }

                level = i;
                teris.setElapsed(i);
            }

            function updateTime() {
                if (!time) return "00: 00";
                var now = Date.now();
                var elapsed = now - time;
                var minutes = parseInt(elapsed / 60000);
                var second = parseInt((elapsed - minutes * 60000) / 1000);
                return ("0" + minutes).slice(-2) + ": " + ("0" + second).slice(-2).slice(-2);
            }
        };
    </script>
    <script>
        var area = document.getElementById("area"),
            canvas = document.getElementById("game-canvas");

        var w = canvas.width = area.offsetWidth;
        var h = canvas.height = area.offsetHeight;
        var tapPosition = { x: 0, y: 0 };
        var ctx = canvas.getContext("2d");
        var loc = {
            up: { x: 77.5, y: 372.5 },
            down: { x: 77.5, y: 442.5 },
            left: { x: 37.5, y: 407.5 },
            right: { x: 117.5, y: 407.5 },
            s: { x: 225.5, y: 372.5 },
            a: { x: 273.5, y: 407.5 },
            b: { x: 225.5, y: 442.5 },
            p: { x: 175, y: 407.5 }
        };

        var upButton = new Button("up", loc.up, teris.clickUp);
        var downButton = new Button("dn", loc.down, teris.clickDown);
        var leftButton = new Button("cl", loc.left, teris.clickLeft);
        var rightButton = new Button("cr", loc.right, teris.clickRight);
        var sButton = new Button("S", loc.s, teris.clickSave);
        var aButton = new Button("A", loc.a, teris.clickRotateRight);
        var bButton = new Button("B", loc.b, teris.clickRotateLeft);
        var stopButtion = new Button("P", loc.p, teris.pauseGame);

        Tap.add(canvas, tapCanvasHandler, false);
        
        teris.start();
        function animate() {
            drawScene();
            requestAnimationFrame(animate);
        }
        
        requestAnimationFrame(animate);

        function tapCanvasHandler(ev) {
            tapPosition.x = this.x;
            tapPosition.y = this.y;
        }

        function drawScene() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            upButton.draw(ctx, tapPosition);
            downButton.draw(ctx, tapPosition);
            leftButton.draw(ctx, tapPosition);
            rightButton.draw(ctx, tapPosition);
            sButton.draw(ctx, tapPosition);
            aButton.draw(ctx, tapPosition);
            bButton.draw(ctx, tapPosition);
            stopButtion.draw(ctx, tapPosition);
            player.draw(ctx);
            teris.draw(ctx);
        }
    </script>
</body>
</html>